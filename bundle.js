(()=>{"use strict";!function(){const e=(e,t=0)=>t+Math.floor((e-t)*Math.random());window.utils={isEscEvent:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())},getRandomNumber:e,getRandomIndexList:(t,n)=>{let o=[];for(let i=0;i<=n-1;i++){let n=e(t.length);for(;o.includes(n);)n=e(t.length);o.push(n)}return o}}}(),window.backend={load:(e,t)=>{const n=new XMLHttpRequest;n.open("get","https://21.javascript.pages.academy/kekstagram/data"),n.responseType="json",n.addEventListener("load",(()=>{e(n.response)})),n.addEventListener("error",(()=>{t("Ошибка загрузки данных")})),n.send()},send:(e,t,n)=>{const o=new XMLHttpRequest;o.open("POST","https://21.javascript.pages.academy/kekstagram "),o.responseType="json",o.addEventListener("load",(()=>{t()})),o.addEventListener("error",(()=>{n()})),o.send(e)}},window.move=(e,t)=>{let n={x:e.clientX,y:e.clientY};const o=e=>{const o={x:n.x-e.clientX,y:n.y-e.clientY};t(o),n={x:e.clientX,y:e.clientY}},i=()=>{document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",i)},window.debounce=()=>{let e=null;return t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)}},function(){const e=document.querySelector("#picture").content.querySelector(".picture"),t=document.querySelector(".pictures");let n=[];window.backend.load((o=>{n=o,(n=>{const o=document.createDocumentFragment();n.forEach(((t,n)=>{o.appendChild(((t,n)=>{const o=e.cloneNode(!0);return o.setAttribute("data-index",n),o.querySelector(".picture__img").src=t.url,o.querySelector(".picture__likes").textContent=t.likes,o.querySelector(".picture__comments").textContent=t.comments.length,o})(t,n))})),t.appendChild(o)})(o),window.addFiltration()}),(e=>{const t=document.createElement("div");t.style="z-index: 1000; padding: 20px; border: 2px dashed red; color: red; font-weight: bold",t.style.position="absolute",t.style.fontSize="50px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)})),t.addEventListener("click",(e=>{if(e.target.matches(".picture img")){const t=e.target.parentElement.getAttribute("data-index");window.bigPicture.show(n[t])}})),window.gallery={picturesContainerElement:t}}(),function(){const e=document.querySelector(".big-picture"),t=e.querySelector(".big-picture__img img"),n=e.querySelector(".social__caption"),o=e.querySelector(".likes-count"),i=e.querySelector("#picture-cancel"),s=()=>{r()},c=e=>{window.utils.isEscEvent(e,r)},r=()=>{e.classList.add("hidden"),document.body.classList.remove("modal-open"),window.commentsLoader.deactivate(),i.removeEventListener("click",s),document.removeEventListener("keydown",c)};window.bigPicture={element:e,show:r=>{t.src=r.url,n.textContent=r.description,o.textContent=r.likes,window.commentsLoader.activate(r),e.classList.remove("hidden"),document.body.classList.add("modal-open"),i.addEventListener("click",s),document.addEventListener("keydown",c)},close:r}}(),function(){const e=window.bigPicture.element,t=e.querySelector(".social__comments"),n=t.querySelector(".social__comment"),o=e.querySelector(".comments-loader"),i=e.querySelector(".social__comment-count"),s=(e,t)=>{i.innerHTML=`${e} из <span class="comments-count">${t}</span> комментариев`},c=e=>{const t=n.cloneNode("true");return t.querySelector(".social__picture").src=e.avatar,t.querySelector(".social__text").textContent=e.message,t};let r;window.commentsLoader={activate:e=>{(e=>{t.innerHTML="";const n=e.length>5?5:e.length;for(let o=0;o<n;o++)t.appendChild(c(e[o]));n===e.length?o.classList.add("hidden"):o.classList.remove("hidden"),s(n,e.length)})(e.comments);const n=(i=t.children.length,e=>{const n=e.length-i,r=n>5?5:n;if(r)for(let n=i;n<i+r;n++)t.appendChild(c(e[n]));(i+=r)===e.length&&o.classList.add("hidden"),s(i,e.length)});var i;r=()=>{n(e.comments)},o.addEventListener("click",r)},deactivate:()=>{o.removeEventListener("click",r)}}}(),function(){const e=document.body.querySelector("main"),t=document.querySelector(".img-upload__form"),n={success:document.querySelector("#success").content.querySelector(".success"),error:document.querySelector("#error").content.querySelector(".error")},o=t=>{const o=n[t].cloneNode("true");e.insertAdjacentElement("afterbegin",o);const i=()=>{e.removeChild(e.children[0]),document.removeEventListener("click",s),document.removeEventListener("keydown",s)},s=e=>{e.target.matches(".success *")&&!e.target.matches(".success__button")||i(),window.utils.isEscEvent(e,i)};document.addEventListener("click",s),document.addEventListener("keydown",s)},i=e=>{e.preventDefault(),window.backend.send(new FormData(t),(()=>{window.photoUpload.deactivate(),o("success")}),(()=>{o("error")}))};window.uploadForm={element:t,addRequest:()=>{t.addEventListener("submit",i)},removeRequest:()=>{t.removeEventListener("submit",i)}}}(),function(){const e=window.uploadForm.element.querySelector(".img-upload__overlay"),t=e.querySelector(".img-upload__cancel"),n=()=>{i(),window.photoUpload.deactivate()},o=e=>{window.utils.isEscEvent(e,(()=>{window.checkFocus.isInputFocused()||(i(),window.uploadForm.element.reset())}))},i=()=>{e.classList.add("hidden"),document.body.classList.remove("modal-open"),t.removeEventListener("click",n),document.removeEventListener("keydown",o)};window.dialogUpload={element:e,show:()=>{e.classList.remove("hidden"),document.body.classList.add("modal-open"),t.addEventListener("click",n),document.addEventListener("keydown",o)},close:i}}(),function(){const e=window.uploadForm.element,t=e.querySelector(".scale__control--smaller"),n=e.querySelector(".scale__control--bigger"),o=e.querySelector(".scale__control--value"),i=100,s=e.querySelector(".img-upload__preview img"),c=e.querySelector(".img-upload__effects"),r=e.querySelector(".effect-level"),d=r.querySelector(".effect-level__value"),l=r.querySelector(".effect-level__line"),a=l.querySelector(".effect-level__pin"),u=l.querySelector(".effect-level__depth"),m={chrome:{min:0,max:1,template:"grayscale({value})"},sepia:{min:0,max:1,template:"sepia({value})"},marvin:{min:0,max:100,template:"invert({value}%)"},phobos:{min:0,max:3,template:"blur({value}px)"},heat:{min:1,max:3,template:"brightness({value})"}},v=e=>{o.value=`${e}%`},w=e=>{s.style.transform=`scale(${e/100})`},p=(()=>{let e=i;return t=>{if(e!==i&&t.target.classList.contains("scale__control--bigger"))e+=25;else{if(25===e||!t.target.classList.contains("scale__control--smaller"))return;e-=25}v(e),w(e)}})(),f=e=>{a.style.left=`${e}px`,u.style.width=`${e}px`;const t=100*e/l.offsetWidth;d.value=t},y=()=>{s.classList="",s.style.filter=""},g=e=>{window.move(e,(e=>{const t=(e=>{const t=l.offsetWidth;let n=a.offsetLeft-e;return n<0&&(n=0),n>t&&(n=t),n})(e.x);f(t),(()=>{const e=(()=>{const e=d.value,t=c.querySelector("input:checked").value,n=m[t].min,o=n+(m[t].max-n)/100*e;return m[t].template.replace("{value}",o)})();s.style.filter=e})()}))},h=()=>{r.classList.add("visually-hidden"),a.removeEventListener("mousedown",g),d.value=0},L=e=>{const t="none"===e.target.value?null:e.target.value;y(),(e=>{e&&(s.classList.add(`effects__preview--${e}`),f(l.offsetWidth))})(t),t&&r.classList.contains("visually-hidden")?(r.classList.remove("visually-hidden"),f(l.offsetWidth),a.addEventListener("mousedown",g)):t||h()};window.photoEdit={imageElement:s,activate:()=>{v(i),w(i),h(),t.addEventListener("click",p),n.addEventListener("click",p),c.addEventListener("change",L)},deactivate:()=>{y(),t.removeEventListener("click",p),n.removeEventListener("click",p),c.removeEventListener("click",L)}}}(),function(){const e=window.uploadForm.element.querySelector(".text__hashtags"),t=/^#[\w]*$/,n=()=>{const n=e.value.split(" ").map((e=>e.toLowerCase()));let o=n.length>5?"нельзя указать больше пяти хэш-тегов":"";o||n.forEach(((e,i)=>{const s=t.test(e);n.indexOf(e)===i?s?s&&1===e.length?o="Хеш-тег не может состоять только из одной решётки":s&&e.length>20&&(o="Хеш-тег не может быть больше 20 символов"):o="Хеш-тег начинается с символа # и состоит из букв и цифр":o="Хеш-теги не должны повторяться"})),e.setCustomValidity(o),e.reportValidity()};window.uploadValidation={add:()=>{e.addEventListener("input",n)},remove:()=>{e.removeEventListener("input",n)}}}(),function(){const e=window.uploadForm.element.querySelector(".img-upload__text").children,t=e=>{e.target.focused=!0},n=e=>{e.target.focused=!1};window.checkFocus={on:()=>{for(let o of e)o.addEventListener("focus",t),o.addEventListener("blur",n)},off:()=>{for(let o of e)o.removeEventListener("focus",t),o.removeEventListener("blur",n)},isInputFocused:()=>Array.from(e).some((e=>e.focused))}}(),function(){const e=["jpg","jpeg","png"];window.setPreview=(t,n,o)=>{const i=t.files[0],s=new FileReader;e.some((e=>i.type.endsWith(e)))&&(s.addEventListener("load",(()=>{n.src=s.result,o()})),s.readAsDataURL(i))}}(),function(){const e=window.photoEdit.imageElement,t=window.uploadForm.element.querySelector("#upload-file"),n=()=>{window.uploadForm.addRequest(),window.photoEdit.activate(),window.uploadValidation.add(),window.checkFocus.on(),window.dialogUpload.show()};t.addEventListener("change",(()=>{window.setPreview(t,e,n)})),window.photoUpload={deactivate:()=>{window.uploadForm.removeRequest(),window.photoEdit.deactivate(),window.uploadValidation.remove(),window.checkFocus.off(),window.dialogUpload.close()}}}(),function(){const e=document.querySelector(".img-filters"),t=e.querySelector(".img-filters__form"),n=window.gallery.picturesContainerElement,o=e=>{e.classList.contains("visually-hidden")&&e.classList.remove("visually-hidden")},i={default:e=>{e.forEach((e=>{o(e),n.appendChild(e)}))},random:e=>{let t=window.utils.getRandomIndexList(e,10);e.forEach(((e,n)=>{t.some((e=>e===n))||e.classList.add("visually-hidden")}))},discussed:e=>{e.slice().sort(((e,t)=>t.querySelector(".picture__comments").textContent-e.querySelector(".picture__comments").textContent)).forEach((e=>{o(e),n.appendChild(e)}))}},s=window.debounce();window.addFiltration=()=>{e.classList.remove("img-filters--inactive");let n=e.querySelector(".img-filters__button--active"),o=document.querySelectorAll(".picture");o=Array.from(o),t.addEventListener("click",(e=>{e.target.classList.contains("img-filters__button--active")||s((()=>{i[e.target.id.slice(7)](o),n.classList.remove("img-filters__button--active"),n=e.target,n.classList.add("img-filters__button--active")}))}))}}()})();